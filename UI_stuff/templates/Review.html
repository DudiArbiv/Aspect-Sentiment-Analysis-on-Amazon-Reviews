<!DOCTYPE html>
<html lang="en">

<head>
     <meta charset="utf-8">
     <meta http-equiv="X-UA-Compatible" content="IE=edge">
     <meta name="viewport" content="width=device-width, initial-scale=1">
     <meta name="description" content="">
     <meta name="author" content="">


     <title>Product Review</title>

     <script type="text/javascript" src="../static/D3/d3.v3.min.js"></script>
     <script type="text/javascript" src="../static/D3/d3.tip.v0.6.3.js"></script>
     <script type="text/javascript" src="../static/D3/d3-queue.v3.min.js"></script>
     <link href="static/css/bootstrap.min.css" rel="stylesheet">

     <script language="JavaScript" type="text/javascript"
     src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js">
     </script>
     <style>
     .axis text {
        font: 20px sans-serif;
      }

      .axis path,
      .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }
      body {background-color: #F5F5F5;}
      .d3_tooltip {
        background: #484848;
        text-align: left;
        font-size: 8;
        font-color: #FFFFFF;
        height: 75px;
        width: 30%;
        border-radius: 5px;
        opacity: 60%;
        padding: 10px;
        position: absolute;
        overflow-y: scroll;
       }
      </style>
</head>

<body>

    <script type="text/javascript">

      window.addEventListener('load', function(){

        // get productID from search
        var productID = localStorage.getItem("product")

        // product name to title, REPLACE WITH ACTUAL PRODUCT NAME
        // document.getElementById("prodName").innerHTML = productID;
        document.getElementById("prodName").innerHTML = "TRS Adapter";

        // CHANGE WHEN FEED IS LIVE restructure data
        // SAMPLE INPUT DATA

        bubbleJSON = [ {"aspect": "product", "cluster": "product", "score": 5, "review": "good quality product"}, {"aspect": "sounds", "cluster": "product", "score": 4, "review": "I purchased this adapter to lessen the risk of breaking off my headphone jack"},
          {"aspect": "length", "cluster": "angle", "score": 1, "review": "I needed this to be able to plug in the IR transmitter into the back of a Samsung TV that I mounted with a flush mount to the wall.  The plug fit perfectly and because of the short length that immediately bends 90 degrees the plug didn't cause the TV to st"}
        ]

        barJSON = [ {"cluster": "angle", "score": 4.55},
                    {"cluster": "cord", "score": 0},
                    {"cluster": "jackets", "score": 0.0},
                    {"cluster": "product", "score": 0.1}]


        // convert to array of arrays for bubble chart
        bubblesList = []
        for (i=0; i<bubbleJSON.length; i++){
          var newRow = []
          newRow.push(bubbleJSON[i]["aspect"])
          newRow.push(bubbleJSON[i]["cluster"])
          newRow.push(bubbleJSON[i]["score"])
          bubblesList.push(newRow)
        }

        barScores = []
        for (i=0; i<barJSON.length; i++){
          var newrow = []
          newrow.push(barJSON[i]["cluster"])
          newrow.push(barJSON[i]["score"])
          barScores.push(newrow)
        }

        var w = window.innerWidth/2 - 20
        var h = window.innerHeight
        var barPadding = 50


        graphH = h/1.3

        // for text / legend
        var svg0 = d3.select("body")
                .append("svg")
                .attr("width", w*2)
                .attr("height", h/8);

        var svg = d3.select("body")
                .append("svg")
                .attr("width", w)
                .attr("height", h*.9-100);

        var svg1 = d3.select("body")
            .append("svg")
            .attr("width", w)
            .attr("height", h*.9-100)

        tool_tip = d3.tip()
           .attr("class", "d3_tooltip")
           .offset([0,-w/3])
           .html(function(d) {
            return "<p style=\"font-family: sans-serif; color: #FFFFFF;\">"+d+"</p>"
            })

        svg.call(tool_tip)
        tool_tip.hide()


        /* DELETE - Initial data for screenshot

        ReviewsJS = {
          "angle": ["Good solution to cord strain for an iPod or radio in your pocket. The right-angle will swivel in the jack instead of allowing certain movements to bend the cord at the plug."],"length": ["I needed this to be able to plug in the IR transmitter into the back of a Samsung TV that I mounted with a flush mount to the wall.  The plug fit perfectly and because of the short length that immediately bends 90 degrees the plug didn't cause the TV to st"], "movements": ["Good solution to cord strain for an iPod or radio in your pocket. The right-angle will swivel in the jack instead of allowing certain movements to bend the cord at the plug."], "adapter": ["This adapter is great for my laptop headphone cord which was getting bent. It does't look to be the best quality"], "cable": ["This item works as described"], "channel": ["I purchased this adapter to lessen the risk of breaking off my headphone jack"], "cord": ["I was really wanting to convert my durable 3.5mm iPad cord into a right angle. So I found this connector that I thought would do the trick. It does ok but doesn't seem to have secure connectivity. It is sort of easy to come unplugged. So I have just gone b"], "headphones": ["Both have worked just fine without any problems"],
            "jack": ["This item works as described"], "mount": ["I needed this to be able to plug in the IR transmitter into the back of a Samsung TV that I mounted with a flush mount to the wall.  The plug fit perfectly and because of the short length that immediately bends 90 degrees the plug didn't cause the TV to st"], "plug": ["This item works as described"], "transmitter": ["I needed this to be able to plug in the IR transmitter into the back of a Samsung TV that I mounted with a flush mount to the wall.  The plug fit perfectly and because of the short length that immediately bends 90 degrees the plug didn't cause the TV to st"], "fashion": ["I purchased this adapter to lessen the risk of breaking off my headphone jack"], "jacket": ["Jacket is large"], "jackets": ["Jacket is large"], "one": ["I purchased this adapter to lessen the risk of breaking off my headphone jack"],"piece": ["This item works as described"], "product": ["good quality product"], "quality": ["This adapter is great for my laptop headphone cord which was getting bent. It does't look to be the best quality"], "set": ["I purchased this adapter to lessen the risk of breaking off my headphone jack"], "solution": ["Good solution to cord strain for an iPod or radio in your pocket. The right-angle will swivel in the jack instead of allowing certain movements to bend the cord at the plug."], "sounds": ["I purchased this adapter to lessen the risk of breaking off my headphone jack"], "use": ["This item works as described"], "value": ["This item works as described"]
        }


        Scores = [["angle", 2.1], ["cord", -2.2], ["product", 1.2], ["jackets", -1.6]]


        scoresJSON = [{"noun": "wire", "cluster": "wire"}, {"noun": "cable", "cluster": "wire"}, {"noun": "wire", "cluster": "wire"},{"noun": "another cable", "cluster": "wire"},{"noun": "another wire", "cluster": "wire"}, {"noun": "", "cluster": "wire"},{"noun": "wire2", "cluster": "wire"}, {"noun": "signal", "cluster": "signal"},{"noun": "more signal", "cluster": "signal"},{"noun": "even moresignal", "cluster": "signal"}, {"noun": "setting", "cluster": "signal"}, {"noun": "signal2", "cluster": "signal"},  {"noun": "test noun", "cluster": "product"},{"noun": "something", "cluster": "product"},{"noun": "something else", "cluster": "product"},{"noun": "different product", "cluster": "product"}, {"noun": "product", "cluster": "product"}] */


        // determine number of unique clusters for bubble chart
        Clusters = []
        for(i=0;i<bubbleJSON.length; i++){
          if(!Clusters.includes(bubbleJSON[i]["cluster"])) {
            Clusters.push(bubbleJSON[i]["cluster"])
          }
        }

        /* restructure data for bubble chart
        Scores3 = []
        for(i=0;i<scoresJSON.length; i++){
          newList = []
          if(scoresJSON[i]["noun"] != "") {
            newList.push(scoresJSON[i]["noun"])
            newList.push(scoresJSON[i]["cluster"])
            newList.push(1)
          }
          Scores3.push(newList)
        }*/

        //data for screenshot
        Scores4 = [["product", "product", 5], ["sounds", "product", 4],
                  ["one", "product", 3],["quality", "product", 2],
                  ["set", "product", 1],["solution", "product", 1],
                  ["piece", "product", 1],["use", "product", 1],
                  ["value", "product", 1],["angle", "angle", 4],
                  ["length", "angle", 1],["movements", "angle", 1],
                  ["adapter", "cord", 1],["cable", "cord", 1],
                  ["channel", "cord", 1],["cord", "cord", 1],
                  ["headphones", "cord", 1],["jack", "cord", 1],
                  ["mount", "cord", 1],["plug", "cord", 1],
                  ["transmitter", "cord", 1],["fashion", "jackets", 1],
                  ["jacket", "jackets", 1],["jackets", "jackets", 1],]
        clusters = ["product", "angle", "cord", "jackets"]

        // CHANGE TO AUTOMATE THIS LEGEND

        var x_scale_leg = d3.scale.ordinal()
          .domain(clusters)
          .rangeBands([w,2*w])

        var col_scale_leg = d3.scale.ordinal()
          .domain(clusters)
          .range(["#1f77b4","#ff7f0e","#9467bd","#8c564b","#17becf","#bcbd22","#e377c2",
            ])

        svg0.selectAll("rect_leg")
          .data(clusters)
          .enter()
          .append("rect")
          .attr("width", 100)
          .attr("height", 30)
          .attr("x", function(d) { return x_scale_leg(d)})
          .attr("y",  h/8 - 30)
          .attr("fill", function(d) { return col_scale_leg(d)})

        svg0.selectAll("text_leg")
          .data(clusters)
          .enter()
          .append("text")
          .text(function(d) { return d})
          .attr("x", function(d) { return x_scale_leg(d)+50})
          .attr("y",  h/8-15)
          .attr("font-family", "sans-serif")
          .style("fill", "white")
          .style("dominant-baseline", "middle")
          .style("text-anchor", "middle")

        //legend title
        svg0.append('text')
            .text("Grouping of Features Appearing in Reviews")
            .attr("font-size", "22px")
            .attr("font-weight", "bold")
            .style("text-anchor", "middle")
            .attr("font-family", "sans-serif")
            .style("dominant-baseline", "middle")
            .attr("x", 1.5*w-20)
            .attr("y", 10)

        svg0.append('text')
            .text("Sized by frequency, click an aspect to view reviews!")
            .attr("font-size", "18px")
            .style("text-anchor", "middle")
            .attr("font-family", "sans-serif")
            .style("dominant-baseline", "middle")
            .attr("x", 1.5*w-20)
            .attr("y", 40)

        var maxSize = Math.min(w,h*.9-100)
        color = d3.scale.category10();

        var bubble = d3.layout.pack()
            .sort(null)
            .size([maxSize, maxSize])
            .value(function(d) {return d[2]})
            .padding(1.5);


        nodes = bubble.nodes({children:Scores4}).filter(function(d) { return !d.children; });

        var bubbles = svg1.append("g")
            .attr("transform", "translate(0,0)")
            .selectAll(".bubble")
            .data(nodes)
            .enter();


        bubbles.append("circle")
            .attr("r", function(d){ return d.r; })
            .attr("cx", function(d){ return d.x; })
            .attr("cy", function(d){ return d.y; })
            .style("fill", function(d) { return col_scale_leg(d[1]); })
            .on("click", showGoodReview)
            .on("mouseover", function(d) { d3.select(this).style("cursor", 'pointer')})
            .on("mouseout", function(d) { d3.select(this).style("cursor", 'default')});


        // bubble text
        bubbles.append("text")
            .attr("x", function(d){ return d.x; })
            .attr("y", function(d){ return d.y + 5; })
            .attr("text-anchor", "middle")
            .text(function(d){ return d[0]; })
            .on("mouseover", function(d) { d3.select(this).style("cursor", 'pointer')})
            .on("mouseout", function(d) { d3.select(this).style("cursor", 'default')})
            .on("click", showGoodReview)
            .style({
                "fill":"white",
                "font-family":"Helvetica Neue, Helvetica, Arial, san-serif",
                "font-size": "12px"
            });

        //bar chart

        var scaleX = d3.scale.linear()
          .domain(d3.extent(barScores, function(d) { return d[1]; }))
          .range([barPadding, w-barPadding]);

        var scaleY = d3.scale.ordinal()
          .domain(barScores.map(function(d) { return d[0]; }))
          .rangeRoundBands([20, h*.9-200], .2);

                //green and red "#2ca02c","#d62728",

        svg.selectAll("rect")
          .data(barScores)
          .enter()
          .append("rect")
          .attr("fill", function(d) { if(d[1] < 0) {return "#d62728"}
                            else {return "#2ca02c"}})
          .attr("x", function(d) { return scaleX(Math.min(0, d[1])); })
          .attr("y", function(d) { return scaleY(d[0]); })
          .attr("width", function(d) { return Math.abs(scaleX(d[1]) - scaleX(0)); })
          .attr("height", scaleY.rangeBand());

        var xAxis = d3.svg.axis()
          .scale(scaleX)
          .orient("bottom");

        var yAxis = d3.svg.axis()
          .scale(scaleY)
          .orient("left")
          .tickSize(0)
          .tickPadding(6);

        barheight = h*.9-200
        svg.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0,"+barheight+")")
          .call(xAxis);

        svg.append("g")
          .attr("class", "y axis")
          .attr("transform", "translate(" + scaleX(0) + ",0)")
          .call(yAxis);

        barHeader = [0, "Feature Group Text Analysis Score"]
        svg0.append("text")
          .text(barHeader[1])
          .attr("x", scaleX(barHeader[0]))
          .attr("y", h/8 - 10)
          .attr("font-size", "22px")
          .attr("font-weight", "bold")
          .style("text-anchor", "middle")
          .attr("font-family", "sans-serif")
          .style("dominant-baseline", "top")

        clicked=false;
        prevAspect = ""
        function showGoodReview() {
          currentAspect = this.__data__[0]

          //DELETE previous way
          //Reviews = ReviewsJS[currentAspect]

          Review = []
          for(i=0; i<bubbleJSON.length; i++){
            if(bubbleJSON[i]["aspect"] == currentAspect) {
              Review = bubbleJSON[i]["review"]
            }
          }



          toPrint = "\""+Review+"\""
          if(toPrint=="\"\""){
            toPrint="Sorry, we are unable to find any reviews for this aspect"
          }
          /*for (i=0; i<Reviews.length; i++){
            toPrint.push("\"")
            toPrint.push(Reviews[i])
            toPrint.push("\"")
          }
          toPrint = toPrint.join("");*/

          if(clicked && prevAspect==currentAspect ) {
            tool_tip.hide(toPrint)
            prevAspect = ""
            clicked = !clicked

          } else if (!clicked && prevAspect!=currentAspect ) {
              tool_tip.show(toPrint)
              prevAspect = currentAspect
              clicked = !clicked
            } else { //switch between tooltips
              tool_tip.hide(toPrint)
              tool_tip.show(toPrint)
              prevAspect = currentAspect
            }
        }
      });

    </script>
    <h1 style="margin-left: 25px";><span id="prodName"></span></h1>



</body>

</html>
